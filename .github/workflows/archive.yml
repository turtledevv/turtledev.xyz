name: Auto Zip Archive

on:
  push:
    branches:
      - main  # or whatever your main branch is

jobs:
  zip-and-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # required for commit checks

      - name: Check if last commit was from bot
        id: check_commit
        run: |
          AUTHOR=$(git log -1 --pretty=format:'%an')
          MESSAGE=$(git log -1 --pretty=format:'%s')
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT
          echo "message=$MESSAGE" >> $GITHUB_OUTPUT

      - name: Exit if last commit was auto archive
        if: contains(steps.check_commit.outputs.message, '[auto] updated archive')
        run: |
          echo "Skipping because last commit was auto archive"
          exit 0

      - name: Delete old Archive.zip if exists
        run: |
          rm -f Archive.zip

      - name: Create Archive.zip
        run: |
          zip -r Archive.zip . -x ".git/*" ".github/*" "Archive.zip"

      - name: Commit and push Archive.zip
        run: |
          git config user.name "GitHub Action"
          git config user.email "actions@github.com"
          git add Archive.zip
          git commit -m "[auto] updated archive"
          git push
